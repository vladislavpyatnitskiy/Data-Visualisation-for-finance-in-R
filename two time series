suppressPackageStartupMessages({
  library(quantmod)
  library(dplyr)
  library(ggplot2)
})

tickers <- c("VIR", "^GSPC")
start_date <- "2022-02-20"

portfolioPrices <- NULL
for (Ticker in tickers) {
  portfolioPrices <- cbind(portfolioPrices,
                           getSymbols(Ticker, from = start_date, src = "yahoo", auto.assign=FALSE)[,4])
}
head(portfolioPrices)

portfolioPrices <- portfolioPrices[apply(portfolioPrices,1,function(x) all(!is.na(x))),]
colnames(portfolioPrices) <- c("VIR", "GSPC")
portfolioReturns <- ROC(portfolioPrices, type = "discrete")

# Time Series of returns

autoplot(portfolioReturns, facets = NULL) +
  scale_color_manual(values = c(VIR = "black", GSPC = "red")) +
  ggtitle("Stock Returns") +
  theme_bw()

Prices <- fortify(portfolioPrices)
(fac <- with(Prices, range(VIR)/range(GSPC)))

fac <- max(fac)

# Time Series of Prices

ggplot(data = Prices, aes(Index, VIR)) +
  geom_line(aes(color = "VIR")) +
  geom_line(aes(y = GSPC * fac, color = "GSPC")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%b %Y") +
  scale_color_manual(values = c(VIR = "red", GSPC = "black")) +
  scale_y_continuous(sec.axis = sec_axis(~ . / fac, name = "S&P 500")) +
  labs(x = "Date", y = "VIR", color = "") +
  ggtitle("Stock Price Dynamics") +
  theme_bw()
